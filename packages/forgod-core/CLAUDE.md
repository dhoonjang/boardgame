# For God Core - 개발 가이드

This file provides guidance to Claude Code (claude.ai/code) when working with forgod-core package.

> For God: 3~6인용 전략 보드게임. 신과 마왕 사이에서 운명을 선택합니다.

## 프로젝트 구조

```
packages/forgod-core/
├── src/
│   ├── types.ts        # 모든 타입 정의
│   ├── constants.ts    # 게임 상수, 스킬, 몬스터, 보드 정의
│   ├── hex.ts          # 6각형 좌표계 유틸리티
│   ├── index.ts        # 모듈 export
│   └── engine/
│       ├── game-engine.ts  # 메인 게임 엔진
│       ├── combat.ts       # 전투 로직
│       ├── skills.ts       # 스킬 시스템
│       ├── revelations.ts  # 계시 카드 시스템
│       ├── monsters.ts     # 몬스터 로직
│       └── victory.ts      # 승리 조건
```

---

## 핵심 타입 구조

### GameState
```typescript
interface GameState {
  id: string
  players: Player[]
  roundNumber: number
  roundTurnOrder: TurnEntry[]  // 이번 라운드 턴 순서 (플레이어 ID들 + 마지막에 'monster')
  currentTurnIndex: number     // 현재 턴 인덱스 (roundTurnOrder 내 위치)
  board: SerializedHexBoard
  monsters: Monster[]
  monsterDice: number[]  // 6개
  revelationDeck: Revelation[]
}

type TurnEntry = string | 'monster'
```

### Player
```typescript
interface Player {
  id: string
  name: string
  heroClass: 'warrior' | 'rogue' | 'mage'
  state: 'holy' | 'corrupt'
  stats: Stats  // strength, dexterity, intelligence (각각 [number, number])
  corruptDice: number | null
  corruptDiceTarget: keyof Stats | null
  health: number
  maxHealth: number
  position: HexCoord
  revelations: Revelation[]
  completedRevelations: Revelation[]
  monsterEssence: number
  devilScore: number
  faithScore: number
  isDead: boolean
  deathTurnsRemaining: number
  skillCooldowns: Record<string, number>
  usedSkillCost: number
  turnPhase: 'move' | 'action'
  remainingMovement: number | null
  leftoverMovement: number
  turnCompleted: boolean
}
```

### Monster
```typescript
interface Monster {
  id: string
  name: string
  position: HexCoord
  health: number
  maxHealth: number
  diceIndices: number[]  // 몬스터 주사위 6개 중 사용하는 주사위 인덱스
  isDead: boolean
}
```

---

## 능력치 시스템

### 능력치 구조
각 능력치는 **주사위 2개**로 구성됩니다:
```typescript
interface Stats {
  strength: [number, number]      // 힘 주사위 2개 (각 1~6)
  dexterity: [number, number]     // 민첩 주사위 2개 (각 1~6)
  intelligence: [number, number]  // 지능 주사위 2개 (각 1~6)
}
```

### 능력치 수치 계산
- **능력치 수치** = 두 주사위의 합 (2~12 범위)
- 예: `[4, 3]` → 능력치 수치 = 7
- 예: `[6, 6]` → 능력치 수치 = 12 (최대)

### 레벨 계산
**레벨 = 가장 높은 능력치 수치** (타락 주사위 제외)

```typescript
const level = Math.max(
  stats.strength[0] + stats.strength[1],
  stats.dexterity[0] + stats.dexterity[1],
  stats.intelligence[0] + stats.intelligence[1]
)
```

예시:
- 힘 `[3, 2]`=5, 민첩 `[4, 3]`=7, 지능 `[2, 1]`=3 → 레벨 7

### 능력치 업그레이드 (ROLL_STAT_DICE)

**비용**: 현재 레벨만큼 몬스터 정수 소모

**과정**:
1. 1d6 굴림
2. **굴린 값보다 낮은** 주사위들을 찾음
3. 그 중 **가장 높은 값**을 가진 주사위를 **+1**
4. 굴린 값 이상인 주사위만 있으면 실패

**예시**:
```
[5, 2]에서 6 굴림 → 5 < 6, 2 < 6 둘 다 후보 → 높은 5를 +1 → [6, 2]
[5, 2]에서 3 굴림 → 2 < 3만 후보 → 2를 +1 → [5, 3]
[5, 2]에서 2 굴림 → 후보 없음 (둘 다 2 이상) → 실패
[6, 4]에서 5 굴림 → 4 < 5만 후보 → 4를 +1 → [6, 5]
```

---

## 체력 시스템

### 최대 체력 테이블
레벨과 직업에 따라 최대 체력이 결정됩니다:

| 직업 | Lv 2~4 | Lv 5~7 | Lv 8~10 | Lv 11 | Lv 12 |
|------|--------|--------|---------|-------|-------|
| 법사 | 20     | 20     | 30      | 40    | 50    |
| 도적 | 20     | 30     | 40      | 50    | 50    |
| 전사 | 30     | 30     | 40      | 50    | 50    |

```typescript
getMaxHealthByLevel(heroClass, level)  // 직업과 레벨로 최대 체력 조회
```

### 체력 변동 규칙
- **레벨업 시 최대 체력 증가** → 현재 체력도 같은 양만큼 증가
  - 예: 최대 30→40 증가 시, 현재 체력 25→35로 증가
- **회복은 최대 체력 초과 불가**

---

## 자원 시스템

### 몬스터 정수 (Monster Essence)
- **획득**: 몬스터에게 **공격으로 가한 피해만큼** 획득
- **사용**: 능력치 주사위 굴리기
- **주의**: 몬스터 처치 보너스와 무관 (오직 피해량만)

```
예: 체력 5인 몬스터에게 100 피해 → 정수 5 획득 (남은 체력만큼만)
```

### 제물 (Sacrifice) - TODO: 미구현
- **종류**: 동그라미(●), 세모(▲), 네모(■)
- **획득**: 몬스터 **처치** 시 획득
- **사용**: 계시 수행
- **분배 규칙**:
  - 막타 용사: 제물의 절반 (내림)
  - 나머지: 인접한 용사들이 타일 숫자 순으로 번갈아 획득

**몬스터별 제물**:
| 몬스터 | ● | ▲ | ■ |
|--------|---|---|---|
| 하피 | 1 | 1 | 0 |
| 그린딜로 | 0 | 1 | 1 |
| 리치 | 3 | 1 | 1 |
| 트롤 | 1 | 0 | 2 |
| 히드라 | 2 | 4 | 1 |
| 골렘 | 1 | 1 | 3 |
| 발록 | 3 | 3 | 3 |

---

## 게임 흐름

### 라운드 구조
1. **플레이어 턴들**: `roundTurnOrder`에 따라 순서대로 진행
2. **몬스터 턴**: 모든 플레이어 턴 후 마지막에 진행
3. **새 라운드**: `leftoverMovement` 기반으로 턴 순서 재결정

### 첫 라운드 턴 순서
- 도적 직업 플레이어 우선, 시계 방향
- 도적이 여러 명이면 랜덤
- 도적이 없으면 랜덤

### 이후 라운드 턴 순서
- 이전 라운드에서 **이동력을 많이 남긴 플레이어** 순서
- 같으면 이전 턴 순서 유지

### 플레이어 턴 페이즈
1. **move 페이즈**
   - `ROLL_MOVE_DICE`: 2d6 + 민첩 수치 = 이동력
   - `MOVE`: 인접 타일로 이동 (지형별 비용 소모)
   - `END_MOVE_PHASE`: action 페이즈로 전환
2. **action 페이즈**
   - `BASIC_ATTACK`: 인접 대상 공격 (힘 수치만큼 피해)
   - `USE_SKILL`: 스킬 사용
   - `ROLL_STAT_DICE`: 능력치 업그레이드
   - `END_TURN`: 턴 완료

### 몬스터 턴
1. 몬스터 주사위 6개 굴림 → 작은 순 정렬
2. 각 몬스터의 `diceIndices`가 가리키는 주사위들 합산
3. 몬스터 효과 발동 (조건 충족 시)
4. 몬스터 공격: `주사위합 % 6` = 공격할 인접 타일 번호

---

## 지형 시스템

### 이동 비용
```typescript
TERRAIN_MOVEMENT_COST = {
  plain: 3,      // 평지
  village: 3,    // 마을
  swamp: 5,      // 늪
  fire: 3,       // 화염
  temple: 3,     // 신전
  castle: 3,     // 마왕성
  monster: 'blocked',   // 몬스터 타일 (이동 불가)
  hill: 'all',          // 언덕 (남은 이동력 전부 소모)
  mountain: 'blocked',  // 산 (이동 불가)
  lake: 'blocked',      // 호수 (이동 불가)
}
```

### 타일 효과
| 타일 | 효과 |
|------|------|
| 마을 | 턴 종료 시 체력 회복 (자기 직업 마을: 10, 다른 직업: 5) |
| 화염 | 지나가거나 턴 시작 시 10 피해 (타락 용사 면역) |
| 신전 | 천사 계시 수행 장소. 타락 용사 진입 불가 (마검 보유 시 가능) |
| 마왕성 | 마왕 계시 수행 장소. 신성 용사 진입 시 피해 |
| 산/호수 | 이동 불가. 강제 이동은 가능. 턴 시작 시 가장 가까운 이동 가능 타일로 이동 |

---

## 스킬 시스템

### 스킬 사용 규칙
- **한 턴에 여러 스킬 사용 가능**
- 조건: `사용한 스킬 비용 합계 ≤ 지능 수치`
- `usedSkillCost`: 이번 턴에 사용한 스킬 비용 합계 (턴 종료 시 0으로 리셋)
- 쿨타임 중인 스킬은 사용 불가

### 전사 스킬
| 이름 | 비용 | 쿨타임 | 설명 |
|------|------|--------|------|
| 돌진 | 1 | 1 | 2칸 떨어진 대상에 근접. 원하는 스킬 쿨 1 감소 |
| 일격 필살 | 2 | 3 | 기본 공격 피해 + 힘 수치 |
| 던져버리기 | 2 | 3 | 대상을 최대 2칸 던짐. 산에 던지면 힘 피해 |
| 무적 태세 | 2 | 3 | 다음 턴까지 모든 피해를 힘 수치만큼 감소 |
| 검기 발사 | 3 | 3 | 앞 3칸에 힘 피해 |

### 도적 스킬
| 이름 | 비용 | 쿨타임 | 설명 |
|------|------|--------|------|
| 독 바르기 | 1 | 1 | 기본 공격 피해 + 민첩 수치 |
| 그림자 함정 | 1 | 2 | 현재 위치에 함정 설치 (최대 3개). 밟으면 민첩 피해 + 은신 |
| 배후 일격 | 2 | 2 | 대상 뒤로 이동하며 민첩 피해 |
| 은신 | 2 | 3 | 공격하거나 받기 전까지 지정 공격 면역 |
| 무한의 표창 | 3 | 3 | 일직선 첫 대상에 민첩 피해. 2칸 이상이면 민첩×2 피해 |

### 법사 스킬
| 이름 | 비용 | 쿨타임 | 설명 |
|------|------|--------|------|
| 스킬 강화 | 2 | 0 | 다른 스킬 강화 |
| 마법 화살 | 2 | 1 | 지능 피해 (용사 사거리 2). 강화: 분신도 공격 |
| 분신 | 2 | 2 | 현재 위치에 분신 생성. 강화: 분신 위치로 순간이동 |
| 마력 방출 | 3 | 2 | 주변 1칸에 지능 피해. 강화: 밀어냄 |
| 메테오 | 4 | 3 | 원하는 타일에 지능 피해. 강화: 지능×2 피해 |

---

## 타락 시스템

### 상태 전환
- **신성 → 타락**: 다른 용사를 **죽일 때**
- **타락 → 신성**: **부활 시** 선택 가능

### 타락 주사위
- 타락 상태로 전환 시 획득 (기본값: 1)
- 추가 처치마다 +1
- 원하는 능력치에 추가 적용 가능
- **신성으로 복귀 시 소멸**

### 타락 용사 특징
- 신전 진입 불가 (마검 보유 시 가능)
- 화염 타일 피해 면역
- 마왕성 진입 시 피해 없음

### 타락 용사 처치
처치한 플레이어가 타락 여부 선택 가능:
- 타락 선택: 타락 주사위 획득
- 신성 유지: 타락 주사위 없음

---

## 부활 시스템

- 죽은 용사는 **3라운드 뒤** 부활
- 죽은 용사의 시체 위치에서 제물 획득 가능
- 부활 시:
  - 계시 카드 1장 획득
  - 타락 여부 선택 가능 (신성 복귀 시 타락 주사위 소멸)

---

## 몬스터 목록

| 이름 | 체력 | 주사위 인덱스 | 효과 |
|------|------|---------------|------|
| 하피 | 20 | 1, 2, 3 | 합 ≥ 7: 인접 용사 한 칸 밀어냄 |
| 그린딜로 | 25 | 2, 4 | 합 ≥ 7: 피해 받은 용사 속박 |
| 리치 | 30 | 4, 5, 6 | 합 ≥ 15: 몬스터들 메테오 면역 |
| 트롤 | 35 | 1, 6 | 타락 용사에게는 홀수일 때만 공격 |
| 히드라 | 40 | 1, 2, 5, 6 | 합 ≥ 15: 잃은 체력의 2배 회복 |
| 골렘 | 50 | 5, 6 | 합 = 12: 기본 공격 피해 무시 |
| 발록 | 60 | 1, 2, 3, 4, 5, 6 | 사망 시 화염 타일 피해 무효화 |

### 몬스터 인접 타일 번호

몬스터 공격 시 `주사위합 % 인접타일수`로 공격 대상 타일을 결정합니다.
타일 번호는 **0부터** 시작하며, `MONSTERS[].adjacentTiles` 배열 순서와 일치합니다.

#### 하피 (7, -3) - 3개 타일
| 번호 | 좌표 | 지형 |
|------|------|------|
| 0 | (7, -4) | 평지 |
| 1 | (6, -2) | 평지 |
| 2 | (7, -2) | 평지 |

#### 그린딜로 (-7, 3) - 3개 타일
| 번호 | 좌표 | 지형 |
|------|------|------|
| 0 | (-6, 3) | 늪 |
| 1 | (-6, 2) | 늪 |
| 2 | (-7, 2) | 늪 |

#### 리치 (6, 3) - 4개 타일
| 번호 | 좌표 | 지형 |
|------|------|------|
| 0 | (7, 2) | 평지 |
| 1 | (6, 2) | 평지 |
| 2 | (5, 3) | 평지 |
| 3 | (5, 4) | 평지 |

#### 트롤 (-6, 8) - 5개 타일
| 번호 | 좌표 | 지형 |
|------|------|------|
| 0 | (-5, 8) | 언덕 |
| 1 | (-5, 7) | 언덕 |
| 2 | (-6, 7) | 언덕 |
| 3 | (-7, 8) | 언덕 |
| 4 | (-6, 9) | 언덕 |

#### 히드라 (-7, -2) - 3개 타일
| 번호 | 좌표 | 지형 |
|------|------|------|
| 0 | (-6, -2) | 늪 |
| 1 | (-8, -1) | 늪 |
| 2 | (-7, -1) | 늪 |

#### 골렘 (7, -8) - 4개 타일
| 번호 | 좌표 | 지형 |
|------|------|------|
| 0 | (8, -8) | 평지 |
| 1 | (8, -9) | 평지 |
| 2 | (7, -9) | 평지 |
| 3 | (6, -8) | 평지 |

#### 발록 (0, 8) - 3개 타일
| 번호 | 좌표 | 지형 |
|------|------|------|
| 0 | (1, 7) | 평지 |
| 1 | (0, 7) | 평지 |
| 2 | (-1, 8) | 평지 |

---

## 승리 조건

**중요**: 승리를 트리거한 플레이어와 실제 승자가 다를 수 있음!

### 마왕 승리
- **트리거**: 타락 용사가 마검 획득 후 **신전** 진입
- **승자**: **마왕 점수 - 신앙 점수**가 가장 높은 플레이어

### 천사 승리
- **트리거**: 게임 종료 천사 계시 수행 (예: "마왕 처단" - 신앙 5점 이상 + 마왕성 진입)
- **승자**: **신앙 점수 - 마왕 점수**가 가장 높은 플레이어

### 계시 승리
- 승리 계시(`isGameEnd=true`) 완료 → 완료한 플레이어가 승리

---

## 점수 시스템

### 마왕 점수
- 마왕 계시 수행 시 획득

### 신앙 점수
- 천사 계시 수행 시 획득

---

## 계시 카드

### 천사 계시 (source: 'angel')
| 이름 | 조건 | 보상 |
|------|------|------|
| 계시 기도 | 제물 1개 신전에 바치기 | 계시 카드 2장 |
| 동그라미 제물 바치기 | ● 신전에 바치기 | 바친 수만큼 신앙 점수, 계시 1장 |
| 발록 공격 | 발록 공격 | 신앙 2점, 계시 1장 |
| 발록 처단 | 신성 상태로 발록 처치 | 신앙 3점, **게임 종료** |
| 마왕 처단 | 신앙 5점+ 달성 후 마왕성 진입 | 신앙 5점, **게임 종료** |

### 마왕 계시 (source: 'demon')
| 이름 | 조건 | 보상 |
|------|------|------|
| 동그라미 제물 수습 | ● 가지고 마왕성 도착 | 바친 수만큼 마왕 점수, 타락주사위+1, 계시 1장 |
| 선제 공격 | 신성 상태로 용사 공격 | 마왕 1점, 타락 전환, 타락주사위 2로 시작 |
| 성장 | 최고 레벨 달성 | 마왕 2점, 계시 1장 |
| 타락 유혹 | 신성 상태로 용사 처치 | 마왕 3점, 타락주사위 3으로 시작, 계시 2장 |
| 마검 뽑기 | 마검 획득 | 마왕 3점, 타락주사위+3, 계시 1장 |

---

## 추가 규칙

### 아이템 교환
인접한 용사끼리 제물 자유롭게 교환 가능

### 마검 시스템

**마검 위치**:
- 마검은 게임 시작 시 특정 타일에 숨겨져 있음
- `GameState.demonSwordPosition`: 마검 위치 (null이면 누군가 획득함)
- 게임 시작 시 모든 플레이어는 마검 위치를 모름 (`knowsDemonSwordPosition: false`)

**마검 위치 공개 조건**:
- **타락 상태로 마왕성(castle) 진입 시** 마검 위치를 알게 됨
- `Player.knowsDemonSwordPosition: true`로 변경
- 신성 상태로 마왕성 진입해도 마검 위치를 알 수 없음

**마검 획득 조건**:
1. 타락 상태여야 함
2. **마검 위치를 알고 있어야 함** (마왕성 방문 필요)
3. 마검 위치에 있어야 함
4. `DRAW_DEMON_SWORD` 액션으로 획득
5. 획득 시 `Player.hasDemonSword = true`

**마왕 승리 경로** (일반적인 흐름):
1. 다른 용사를 처치하여 타락
2. 마왕성 방문 → 마검 위치 획득
3. 마검 위치로 이동 → 마검 획득
4. 신전 진입 → 마왕 승리 트리거

**마검 특수 규칙**:
- 마검 소유자는 몬스터와 싸울 수 없음
- 마검 소유자 사망 시 타락 용사가 시체 위에서 마검 획득 가능
- 마검 보유 시 타락 상태에서도 신전 진입 가능
